<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Socket.io</title>
</head>

<body>
    <h2>Chat <span id="connect_title"></span></h2>
    <h3>Room: <span id="room_title"></span></h3>
    <h3>Id: <span id="id_title"></span></h3>
    <div>
        <input type="text" id="room_id" value="square">
        <button type="button" onclick="checkRoom()">Join Room</button>
    </div>

    <div>
        <input type="text" id="chat_text" value="Message">
        <button type="button" onclick="sendAll()">Send</button>
    </div>

    <div id="chat_list"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let joinedRoom = null;

        socket.on('connect', function () {
            console.log('[client] connected', Date());
            document.querySelector('#connect_title').innerHTML = 'âœ…';
        });

        socket.on('message', (message) => {
            console.log('[client] MSG: ', message.msg);
            document.querySelector('#id_title').innerHTML = message.msg;
        });

        function checkRoom() {
            const roomId = document.querySelector('#room_id').value;
            // console.log('[client] checkRoom() room id : ', roomId);

            if (!roomId) {
                alert('empty room id');
                return
            }

            joinRoom(roomId);
        }

        function joinRoom(roomId) {
            console.log('[client] joinRoom() room id : ', roomId);
            socket.emit('join', roomId, () => {
                console.log("[client] joined Room>>", roomId)

                socket.emit('leave', joinedRoom, () => {
                    console.log("[client] leave Room>>", joinedRoom)
                });

                joinedRoom = roomId;

                displayRooms();
            });
        }

        function displayRooms() {
            console.log('joinedRoom', joinedRoom);
            document.querySelector('#room_title').innerHTML = joinedRoom
        }

        function sendAll() {
            const chatText = document.querySelector('#chat_text').value;
            // console.log(chatText);
            socket.emit('message', { roomId: joinedRoom, msg: chatText }, (result) => {
                console.log('[client] SendAll Callback result: ', result);

                const chatList = document.querySelector('#chat_list')
                const div = document.createElement('div');
                div.innerHTML = chatText;
                
                chatList.appendChild(div);
            });
        }
    </script>
</body>

</html>